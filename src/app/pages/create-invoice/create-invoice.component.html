<div class="create-invoice-container">
  <div class="invoice-header">
    <h2>{{ isEditMode ? 'Edit Invoice' : 'Create Invoice' }}</h2>
    <button type="button" class="back-btn" (click)="goBack()">‚Üê Back to Dashboard</button>
  </div>

  <form class="invoice-form">
    <!-- Invoice Basic Details -->
    <div class="form-section">
      <h3>üìã Invoice Details</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="invoiceNumber">Invoice Number</label>
          <input 
            type="text" 
            id="invoiceNumber" 
            [(ngModel)]="invoice.invoiceNumber" 
            name="invoiceNumber"
            class="form-control">
        </div>
        <div class="form-group">
          <label for="invoiceDate">Invoice Date</label>
          <input 
            type="date" 
            id="invoiceDate" 
            [(ngModel)]="invoice.invoiceDate" 
            name="invoiceDate"
            class="form-control">
        </div>
      </div>
    </div>

    <!-- Customer Selection -->
    <div class="form-section">
      <h3>üë§ Customer Details</h3>
      
      <div class="radio-group">
        <label class="radio-option">
          <input 
            type="radio" 
            [(ngModel)]="invoice.customerType" 
            name="customerType" 
            value="existing"
            (change)="onCustomerTypeChange()">
          <span>Existing Customer</span>
        </label>
        <label class="radio-option">
          <input 
            type="radio" 
            [(ngModel)]="invoice.customerType" 
            name="customerType" 
            value="new"
            (change)="onCustomerTypeChange()">
          <span>New Customer</span>
        </label>
      </div>

      <!-- Existing Customer Search -->
      <div *ngIf="invoice.customerType === 'existing'" class="customer-search">
        <div class="form-group">
          <label for="customerSearch">Search Customer (Name or Mobile)</label>
          <input 
            type="text" 
            id="customerSearch"
            [(ngModel)]="invoice.searchTerm" 
            name="customerSearch"
            placeholder="Enter customer name or mobile number"
            class="form-control"
            (input)="searchCustomer()">
        </div>

        <!-- Search Results -->
        <div *ngIf="searchResults.length > 0" class="search-results">
          <div 
            *ngFor="let customer of searchResults" 
            class="customer-result"
            (click)="selectCustomer(customer)">
            <div class="customer-info">
              <span class="customer-name">{{customer.name}}</span>
              <span class="customer-mobile">{{customer.mobile}}</span>
              <span class="customer-email">{{customer.email}}</span>
            </div>
          </div>
        </div>

        <!-- Selected Customer Display -->
        <div *ngIf="invoice.customer" class="selected-customer">
          <h4>Selected Customer:</h4>
          <div class="customer-card">
            <p><strong>{{invoice.customer.prefix}} {{invoice.customer.firstName}} {{invoice.customer.lastName}}</strong></p>
            <p>Mobile: {{invoice.customer.mobile}}</p>
            <p>Email: {{invoice.customer.email}}</p>
            <p>Address: {{invoice.customer.address}}, {{invoice.customer.city}}, {{invoice.customer.state}} - {{invoice.customer.pincode}}</p>
          </div>
        </div>

        <!-- Add New Customer Button -->
        <button 
          *ngIf="invoice.searchTerm && searchResults.length === 0" 
          type="button" 
          class="add-customer-btn"
          (click)="showAddNewCustomer()">
          + Add New Customer
        </button>
      </div>

      <!-- New Customer Form -->
      <div *ngIf="invoice.customerType === 'new' || showAddCustomerForm" class="new-customer-form">
        <h4>Add Customer Details</h4>
        
        <!-- Customer Type Selection -->
        <div class="form-group">
          <label>Customer Type *</label>
          <div class="radio-group-horizontal">
            <label class="radio-option">
              <input type="radio" name="newCustomerType" value="individual" [(ngModel)]="newCustomer.customerType" />
              Individual
            </label>
            <label class="radio-option">
              <input type="radio" name="newCustomerType" value="company" [(ngModel)]="newCustomer.customerType" />
              Company
            </label>
          </div>
        </div>

        <!-- Individual Customer Name -->
        <div *ngIf="newCustomer.customerType === 'individual'" class="form-group">
          <label>Customer Name *</label>
          <div class="form-row">
            <div class="form-group small">
              <input type="text" [(ngModel)]="newCustomer.prefix" name="prefix" placeholder="Prefix" class="form-control" />
            </div>
            <div class="form-group">
              <input type="text" [(ngModel)]="newCustomer.firstName" name="firstName" placeholder="First Name" class="form-control" required />
            </div>
          </div>
        </div>
        
        <div *ngIf="newCustomer.customerType === 'individual'" class="form-group">
          <label for="middleName">Middle Name</label>
          <input type="text" [(ngModel)]="newCustomer.middleName" name="middleName" placeholder="Enter middle name" class="form-control" />
        </div>
        
        <div *ngIf="newCustomer.customerType === 'individual'" class="form-group">
          <label for="lastName">Last Name *</label>
          <input type="text" [(ngModel)]="newCustomer.lastName" name="lastName" placeholder="Enter last name" class="form-control" required />
        </div>

        <!-- Company Customer Name -->
        <div *ngIf="newCustomer.customerType === 'company'" class="form-group">
          <label for="companyName">Company Name *</label>
          <input type="text" [(ngModel)]="newCustomer.companyName" name="companyName" placeholder="Enter company name" class="form-control" required />
        </div>
        
        <div *ngIf="newCustomer.customerType === 'company'" class="form-group">
          <label for="companyType">Company Type *</label>
          <select [(ngModel)]="newCustomer.companyType" name="companyType" class="form-control" required>
            <option value="">Select Company Type</option>
            <option *ngFor="let type of companyTypeOptions" [value]="type">{{type}}</option>
          </select>
        </div>

        <!-- Mobile Number -->
        <div class="form-group">
          <label>Mobile Number *</label>
          <div class="form-row">
            <div class="form-group small">
              <select [(ngModel)]="newCustomer.countryCode" name="countryCode" class="form-control">
                <option *ngFor="let country of countryCodeOptions" [value]="country.code">{{country.code}} {{country.country}}</option>
              </select>
            </div>
            <div class="form-group">
              <input type="tel" [(ngModel)]="newCustomer.mobile" name="mobile" placeholder="Enter mobile number" class="form-control" required />
            </div>
          </div>
        </div>

        <!-- GST and Email -->
        <div class="form-row">
          <div class="form-group">
            <label for="gst">GST Number</label>
            <input type="text" [(ngModel)]="newCustomer.gst" name="gst" placeholder="Enter GST number" class="form-control" />
          </div>
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" [(ngModel)]="newCustomer.email" name="email" placeholder="Enter email address" class="form-control" />
          </div>
        </div>

        <!-- Address Section -->
        <div class="address-section">
          <h5>Address Information</h5>
          
          <div class="form-group">
            <label for="addressLine1">Address Line 1 *</label>
            <input type="text" [(ngModel)]="newCustomer.addressLine1" name="addressLine1" placeholder="Enter address line 1" class="form-control" required />
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="village">Village *</label>
              <input type="text" [(ngModel)]="newCustomer.village" name="village" placeholder="Enter village name" class="form-control" required />
            </div>
            <div class="form-group">
              <label for="taluka">Taluka</label>
              <input type="text" [(ngModel)]="newCustomer.taluka" name="taluka" placeholder="Enter taluka name" class="form-control" />
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="district">District *</label>
              <input type="text" [(ngModel)]="newCustomer.district" name="district" placeholder="Enter district name" class="form-control" required />
            </div>
            <div class="form-group">
              <label for="pinCode">Pin Code</label>
              <input type="text" [(ngModel)]="newCustomer.pinCode" name="pinCode" placeholder="Enter pin code" pattern="[0-9]{6}" class="form-control" />
            </div>
          </div>
        </div>

        <button *ngIf="showAddCustomerForm" type="button" class="save-customer-btn" (click)="addNewCustomer()">
          Save Customer
        </button>
      </div>
    </div>

    <!-- Service Details -->
    <div class="form-section">
      <h3>üíº Service Details</h3>
      
      <div *ngFor="let service of invoice.serviceDetails; let i = index" class="service-item">
        <div class="service-header">
          <h4>Service {{i + 1}}</h4>
          <button 
            *ngIf="invoice.serviceDetails.length > 1"
            type="button" 
            class="remove-service-btn"
            (click)="removeServiceDetail(i)">
            ‚úï
          </button>
        </div>
        
        <div class="form-group">
          <label for="description{{i}}">Service Description / Particulars *</label>
          <select 
            id="description{{i}}"
            [(ngModel)]="service.description" 
            name="description{{i}}"
            class="form-control service-dropdown"
            (change)="onServiceDescriptionChange(i, $event)">
            <option value="">Select a service or enter custom description</option>
            <option *ngFor="let option of serviceOptions" [value]="option">{{ option }}</option>
            <option value="custom">‚ö° Enter Custom Description</option>
          </select>
          
          <!-- Custom description input - shown when 'custom' is selected -->
          <input 
            *ngIf="service.description === 'custom'"
            type="text" 
            [(ngModel)]="service.customDescription"
            name="customDescription{{i}}"
            placeholder="Enter your custom service description..."
            class="form-control custom-input"
            (blur)="onCustomDescriptionBlur(i)">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="amount{{i}}">Amount *</label>
            <input 
              type="number" 
              id="amount{{i}}"
              [(ngModel)]="service.amount" 
              name="amount{{i}}"
              min="0"
              step="0.01"
              class="form-control"
              (input)="onAmountChange()">
          </div>
          <div class="form-group">
            <label for="notes{{i}}">Notes (Optional)</label>
            <input 
              type="text" 
              id="notes{{i}}"
              [(ngModel)]="service.notes" 
              name="notes{{i}}"
              placeholder="e.g., Including challan fees"
              class="form-control">
          </div>
        </div>
      </div>

      <button type="button" class="add-service-btn" (click)="addServiceDetail()">
        + Add Another Service
      </button>
    </div>

    <!-- Payment Summary -->
    <div class="form-section">
      <h3>üí∞ Payment Summary</h3>
      
      <div class="payment-summary">
        <div class="summary-row">
          <span class="label">Total Amount:</span>
          <span class="amount">‚Çπ{{invoice.totalAmount | number:'1.2-2'}}</span>
        </div>
        
        <div class="form-group">
          <label for="advanceReceived">Advance Received</label>
          <input 
            type="number" 
            id="advanceReceived"
            [(ngModel)]="invoice.advanceReceived" 
            name="advanceReceived"
            min="0"
            step="0.01"
            class="form-control"
            (input)="onAdvanceChange()">
        </div>
        
        <div class="summary-row total">
          <span class="label">Balance / Net Payable:</span>
          <span class="amount">‚Çπ{{invoice.balancePayable | number:'1.2-2'}}</span>
        </div>
      </div>
    </div>

    <!-- Bank Account Selection -->
    <div class="form-section">
      <h3>üè¶ Bank Account</h3>
      <div class="form-group">
        <label for="bankAccount">Select Bank Account (To Receive Amount) *</label>
        <select id="bankAccount" [(ngModel)]="invoice.selectedBank" name="bankAccount" class="form-control" required>
          <option value="">Select Bank Account</option>
          <option *ngFor="let bank of bankAccounts" [value]="bank">{{bank}}</option>
        </select>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="form-actions">
      <button type="button" class="cancel-btn" (click)="goBack()">Cancel</button>
      <button type="button" class="save-btn" (click)="previewInvoice()">
        {{ isEditMode ? 'Preview Changes' : 'Preview Invoice' }}
      </button>
    </div>
  </form>
</div>
